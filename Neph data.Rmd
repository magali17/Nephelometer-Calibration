---
title: "PM Data Exploration"
author: "Magali Blanco"
date:  "10/9/17"
output: word_document
---


```{r global_options, echo=F}
library(knitr)
knitr::opts_chunk$set(fig.width=7, fig.height=6, echo=F, warning=F, message=F )

```

```{r notes, include=FALSE}

# TO DO
# ZOOM into values by source to see temporal patterns  

#NOTES
# merging by QmuCode essentialy binds rows

#get many errors: "Coercing boolean to numeric in..."
 
# how add TOC?

```

```{r data merging, include=FALSE}

#upload & merge data
library(readxl)

QmuCodes <- read_excel("~/Everything/School/PhD_UW/Courses/1. Aut 2017/ENVH 595 Rotation A/data-cleanup/Datasets/UWPSCAAqueries/z. Methods - QMU codes.xlsx")
#View(Methods_codes)
colnames(QmuCodes)[1] <- "QmuCode"
#View(QmuCodes)

Stations <- read_excel("~/Everything/School/PhD_UW/Courses/1. Aut 2017/ENVH 595 Rotation A/data-cleanup/Datasets/UWPSCAAqueries/z. Stations for UW.xlsx", 
    col_types = c("text", "text", "text", 
        "date", "date", "text", "text", "text", 
        "text", "numeric", "numeric", "numeric", 
        "text", "numeric", "numeric", "numeric", 
        "numeric", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric"))
#View(Stations)

#merge datasets (ds) w/ QMU data & change "Daily24HourAvg" to ID each ds
PM2.5_BC_UV_data <- read_excel("~/Everything/School/PhD_UW/Courses/1. Aut 2017/ENVH 595 Rotation A/data-cleanup/Datasets/UWPSCAAqueries/PM2_5 and BC and UV data.xlsx", col_types = c("text", "numeric", "date", "numeric"))
#Ref_QMU_Data <- merge(PM2.5_BC_UV_data,QmuCodes, by="QmuCode", all.x=T )
#colnames(PM2.5_BC_UV_data)[colnames(PM2.5_BC_UV_data)=="Daily24HourAvg"]   <- "Ref24HrAvg"

PM2.5_BC_UV_data$Source <- "Gravimetric"

light_scattering_data <- read_excel("~/Everything/School/PhD_UW/Courses/1. Aut 2017/ENVH 595 Rotation A/data-cleanup/Datasets/UWPSCAAqueries/LightScattering data.xlsx", col_types = c("text", "text", "date", "numeric"))
#LS_QMU_Data <- merge(light_scattering_data, QmuCodes, by="QmuCode", all.x=T)
#colnames(light_scattering_data)[colnames(light_scattering_data)=="Daily24HourAvg"]   <- "LS24HrAvg"

light_scattering_data$Source <- "Light Scattering"

TSP_data <- read_excel("~/Everything/School/PhD_UW/Courses/1. Aut 2017/ENVH 595 Rotation A/data-cleanup/Datasets/UWPSCAAqueries/TSP data.xlsx", col_types = c("text", "text", "date", "numeric"))
#TSP_QMU_Data <- merge(TSP_data, QmuCodes, by="QmuCode", all.x=T)
#colnames(TSP_data)[colnames(TSP_data)=="Daily24HourAvg"]   <- "TSP24HrAvg"

TSP_data$Source <- "TSP"

Visual_Range_data <- read_excel("~/Everything/School/PhD_UW/Courses/1. Aut 2017/ENVH 595 Rotation A/data-cleanup/Datasets/UWPSCAAqueries/Visual Range data.xlsx", col_types = c("text", "numeric", "date", "numeric"))
#VR_QMU_Data <- merge(Visual_Range_data, QmuCodes, by="QmuCode", all.x=T)
#colnames(Visual_Range_data)[colnames(Visual_Range_data)=="Daily24HourAvg"]   <- "VR24HrAvg"

Visual_Range_data$Source <- "Visual Range"

#merge data by date, station, QMU code, all=T
# PM <- merge(merge(merge(PM2.5_BC_UV_data, light_scattering_data,by=c("StationCode", "QmuCode","ObservedDate"), all=T), TSP_data,by=c("StationCode", "QmuCode","ObservedDate"), all=T), Visual_Range_data, by=c("StationCode", "QmuCode","ObservedDate"), all=T)

# merge w/ QMU codes & stations ds
#PM <- merge(merge(PM, QmuCodes, by="QmuCode", all.x = T), Stations, by="StationCode", all.x=T)

# OR: bind by rows

PM <- rbind(PM2.5_BC_UV_data,light_scattering_data,TSP_data,Visual_Range_data)

# add QMU & stations data
PM <- merge(merge(PM, QmuCodes, by="QmuCode", all.x=T), Stations, by="StationCode", all.x=T)
PM$PollutantType <- as.factor(PM$PollutantType)
PM$Source <- as.factor(PM$Source)

#check station codes
PM$StationCode[PM$StationCode=="tb"] <- "TB"
PM$StationCode[PM$StationCode=="tc"] <- "TC"
PM$StationCode[PM$StationCode=="td"] <- "TD"
PM$StationCode[PM$StationCode=="te"] <- "TE"
PM$StationCode[PM$StationCode=="tf"] <- "TF"
PM$StationCode[PM$StationCode=="Ck"] <- "CK"
PM$StationCode <- as.factor(PM$StationCode)

PM$QmuCode <- as.numeric(PM$QmuCode)


PM.full <- PM

PM <- PM.full[c("StationCode", "QmuCode", "ObservedDate", "Daily24HourAvg", "Source", "UnitsShort", "FinalLat","FinalLong")]

```
 

# Data Availability 

Overall data availability:  
* Gravimetric PM2.5  
* TSP  
* Light Scattering  
* Visual Range  

```{r Overall_smokestack}
library(ggplot2)

StationUnique <-data.frame(StationCode=unique(PM$StationCode))
StationUnique$StationNo <- seq(1:length(unique(PM$StationCode)))
PM <- merge(PM, StationUnique, by="StationCode")

ggplot(data=PM, aes(x=ObservedDate, y=StationNo, colour=Source)) + geom_point() + 
  labs(x= "Date", y="Station No.") + theme(legend.position = "bottom")  

```

```{r table1}
table1 <-data.frame(StartDate=min(PM$ObservedDate),
                    EndDAte=max(PM$ObservedDate),
                    #DayRange = as.numeric(max(PM$ObservedDate) - min(PM$ObservedDate)),
                    YearRange=round((as.numeric(max(PM$ObservedDate) - min(PM$ObservedDate)))/365,1),
                    Values=length(!is.na(PM$Daily24HourAvg)),
                    UniqueStations=length(unique(PM$StationCode)),
                    UniqueQMUCodes=length(unique(PM$QmuCode)))
table1$MeanValuesPerYear <- round(table1$Values / table1$YearRange)
table1$MeanValuesPerDay <- round(table1$Values / (table1$YearRange*365))
table1 <- table1[c(1:4,7:8,5:6)]
kable(table1, caption="Overall Data Availability", col.names = c("Start", "End", "Yrs", "Smpl", "Avg Smpl/Yr", "Avg Smpl/Dy", "No. Stations", "No. QMUs") )


```

Gravimetric data availability  
```{r Grav_data_avail}
ggplot(data=PM[PM$Source=="Gravimetric",], aes(x=ObservedDate, y=StationNo)) + geom_point() + 
  labs(x= "Date", y="Station No.") + theme(legend.position = "none")

```

TSP data availability  
```{r TSP_data_avail}
ggplot(data=PM[PM$Source=="TSP",], aes(x=ObservedDate, y=StationNo)) + geom_point() + 
  labs(x= "Date", y="Station No.") + theme(legend.position = "none")


```

Light scattering data availability  
```{r Light_scattering_data_avail}
ggplot(data=PM[PM$Source=="Light Scattering",], aes(x=ObservedDate, y=StationNo)) + geom_point() + 
  labs(x= "Date", y="Station No.") + theme(legend.position = "none")

```

Visual range data availability  
```{r Visual_range_data_avail}
ggplot(data=PM[PM$Source=="Visual Range",], aes(x=ObservedDate, y=StationNo)) + geom_point() + 
  labs(x= "Date", y="Station No.") + theme(legend.position = "none")

```

# PM Over Time by Source
Are they continuous?  
Do they increase/decrease over time? (make plots for time ranges?)  
Are there temporal trends?  
Are changes in methods associated with changes in PM?  
Zoom in to see temporal patterns??  

Gravimetric Samples of PM2.5 Over Time  
```{r PM2.5_over_time}
ggplot(data = PM[PM$Source=="Gravimetric",], aes(x=ObservedDate, y=Daily24HourAvg, colour=as.factor(QmuCode))) + geom_point() + labs(x="Date", y="Daily Avg (ug/m3)", colour="QMU Codes") +
  theme(legend.position = "bottom")
  #xlim(as.POSIXct("1999-01-01"), as.POSIXct("2000-01-01"))


```

TSP Over Time  
```{r TSP_over_time}
ggplot(data = PM[PM$Source=="TSP",], aes(x=ObservedDate, y=Daily24HourAvg, colour=as.factor(QmuCode))) + geom_point() + labs(x="Date", y="Daily Avg (ug/m3)", col="QMU Codes") + theme(legend.position = "bottom") #+xlim(as.POSIXct("1985-01-01"), as.POSIXct("1986-01-01"))


```

Light Scattering Over Time  
```{r Light_scattering_over_time}
ggplot(data = PM[PM$Source=="Light Scattering",], aes(x=ObservedDate, y=Daily24HourAvg, colour=as.factor(QmuCode))) + geom_point() + labs(x="Date", y="Daily Avg (bscat10e-5)", col="QMU Codes") + theme(legend.position = "bottom") #+xlim(as.POSIXct("1985-01-01"), as.POSIXct("1986-01-01"))

```

Visual Range Over Time  
```{r Visual_range_over_time}
ggplot(data = PM[PM$Source=="Visual Range",], aes(x=ObservedDate, y=Daily24HourAvg, colour=as.factor(QmuCode))) + geom_point() + labs(x="Date", y="Daily Avg (Mi)", col="QMU Codes") + theme(legend.position = "bottom") #+xlim(as.POSIXct("1990-01-01"), as.POSIXct("1991-01-01"))

```

```{r table2}
table2 <- data.frame(Source=c("Gravimetric", "TSP", "Light Scattering", "Visual Range"),
                     StartDate=as.Date(c(min(PM$ObservedDate[PM$Source=="Gravimetric"]),
                                 min(PM$ObservedDate[PM$Source=="TSP"]),
                                 min(PM$ObservedDate[PM$Source=="Light Scattering"]),
                                 min(PM$ObservedDate[PM$Source=="Visual Range"]))),
                      EndDate=as.Date(c(max(PM$ObservedDate[PM$Source=="Gravimetric"]),
                                 max(PM$ObservedDate[PM$Source=="TSP"]),
                                 max(PM$ObservedDate[PM$Source=="Light Scattering"]),
                                 max(PM$ObservedDate[PM$Source=="Visual Range"]))),
                     Values=c(sum(!is.na(PM$Daily24HourAvg[PM$Source=="Gravimetric"])),
                                  sum(!is.na(PM$Daily24HourAvg[PM$Source=="TSP"])),
                                  sum(!is.na(PM$Daily24HourAvg[PM$Source=="Light Scattering"])),
                                  sum(!is.na(PM$Daily24HourAvg[PM$Source=="Visual Range"]))),
                     UniqueStations=c(length(unique(PM$StationCode[PM$Source=="Gravimetric"])),
                                      length(unique(PM$StationCode[PM$Source=="TSP"])),
                                      length(unique(PM$StationCode[PM$Source=="Light Scattering"])),
                                      length(unique(PM$StationCode[PM$Source=="Visual Range"]))),
                     UniqueQMUCodes=c(length(unique(PM$QmuCode[PM$Source=="Gravimetric"])),
                                      length(unique(PM$QmuCode[PM$Source=="TSP"])),
                                      length(unique(PM$QmuCode[PM$Source=="Light Scattering"])),
                                      length(unique(PM$QmuCode[PM$Source=="Visual Range"]))) )
table2$YearRange <-round(as.numeric(table2$EndDate - table2$StartDate)/365,1)
table2$MeanValuesPerYear <- round(table2$Values / table2$YearRange)
table2$MeanValuesPerDay <- round(table2$Values / (table2$YearRange*365))
table2$SamplingFreqDys <- c(1,3,1,1)

table2 <-table2[c("Source", "StartDate", "EndDate", "YearRange", "Values", "MeanValuesPerYear", "MeanValuesPerDay", "SamplingFreqDys", "UniqueStations", "UniqueQMUCodes")]

kable(table2, caption= "Data Availability by Source", col.names = c("Source", "Start", "End", "YRS", "Smpl", "Avg Smpl/Yr", "Avg Smpl/Dy", "Smpl Freq", "No. Stations", "No. QMUs"))
```


# Missing Data 
????  

```{r Missing_data}
# Gravimetric, daily
# Light Scattering, daily
# Visual Range, daily
# TSP, every 3 days

## % missing data here for Gravimetric
grav.na <- round(length(which(is.na(PM$Daily24HourAvg[PM$Source=="Gravimetric"]))) / length(PM$Daily24HourAvg[PM$Source=="Gravimetric"]) *100,0)
## % missing data here for TSP
tsp.na <- round(length(which(is.na(PM$Daily24HourAvg[PM$Source=="TSP"]))) / length(PM$Daily24HourAvg[PM$Source=="TSP"]) *100,0)
## % missing data here for Visual Range
vr.na <- round(length(which(is.na(PM$Daily24HourAvg[PM$Source=="Visual Range"]))) / length(PM$Daily24HourAvg[PM$Source=="Visual Range"]) *100,0)
## % missing data here for Light Scattering
ls.na <- round(length(which(is.na(PM$Daily24HourAvg[PM$Source=="Light Scattering"]))) / length(PM$Daily24HourAvg[PM$Source=="Light Scattering"]) *100,0)

# # % NAs in datasets 
list1 <- c("Overall", "Gravimetric", "TSP", "Visual Range", "Light Scattering")
NAdf <- data.frame(Source=list1,NAs=rep(NA,length(list1)))

NAdf$NAs[NAdf$Source=="Overall"] <-round(length(which(is.na(PM$Daily24HourAvg))) / length(PM$Daily24HourAvg) *100,0)

NAdf$NAs[2] <-grav.na
NAdf$NAs[3] <-tsp.na
NAdf$NAs[4] <-vr.na
NAdf$NAs[5] <-ls.na

NAdf$NAs <- paste(NAdf$NAs, "%", sep = "")

kable(NAdf, caption="Percent NAs in Datasets")


# for (i in 2:length(list1)){
#   NAperc[i] <- paste(round(length(which(is.na(PM$Daily24HourAvg[PM$Source==list1[i]]))) / length(PM$Daily24HourAvg[PM$Source==list1[i]]) *100,0),"%", sep = "")
#   
#   NAdf$NAs[i] <- NAperc[i]
#   }
# 
#   NAdf


```

How often does each source sample PM? Daily? Every 3 days? 7 days?

How much data should be here? for each station or mean # days/station: (observed days) / (unique stations) x (1 / x days sampling frequency)

??? What percent of data is missing, by year?
```{r}

```


# Correlate Gravimetric reference data to ?? TSP ?? 

???by ObservedDate & StationCode

Compare to RH values. Are there RH ranges that are associated with poor gravimetric-TSP correlation?

Gravimetric PM2.5 vs TSP
```{r Grav_TSP_Corr_and_RH}
PM.grav <- subset(PM, Source=="Gravimetric")
colnames(PM.grav)[colnames(PM.grav)=="Daily24HourAvg"] <- "Grav.Avg"
PM.TSP <- subset(PM, Source=="TSP")
colnames(PM.TSP)[colnames(PM.TSP)=="Daily24HourAvg"] <- "TSP.Avg"

# ggplot(data = PM[PM$Source=="Gravimetric" | PM$Source=="TSP",], aes(x=PM$Daily24HourAvg[PM$Source=="Gravimetric"],
#  y=PM$Daily24HourAvg[PM$Source=="TSP"])) + geom_point()

PM.grav.TSP <- merge(PM.grav, PM.TSP, by="ObservedDate")

ggplot(data=PM.grav.TSP, aes(x=Grav.Avg, y=TSP.Avg)) + geom_point() + stat_smooth(method="lm", se=F, color="blue") + labs(x="Gravimetric PM2.5 (ug/m3)", y="TSP (ug/sdm3)")


```

```{r Grav_TSP_lm}

lmGravTSP <- summary(lm(TSP.Avg~Grav.Avg, data=PM.grav.TSP))
kable(lmGravTSP$coefficients, caption = "Gravimetric PM2.5 and TSP Linear Model")


```



# Summary of concentration levels per method/instrument
How do these values compare to the method/instrument's detection limits?

Gravimetric: PM2.5


```{r detection_limits}




```

